// Este é o datasource e o generator.
// Certifique-se de que a variável DATABASE_URL em seu .env aponta para um banco PostgreSQL.

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}
        

// --- ENUMS ---
// Enums ajudam a padronizar valores de campos específicos.

// Status de um Pedido
enum OrderStatus {
  PENDING    // Pedido criado, aguardando pagamento
  PAID       // Pagamento confirmado
  PROCESSING // Pedido em separação no estoque
  SHIPPED    // Enviado para a transportadora
  DELIVERED  // Entregue ao cliente
  CANCELLED  // Pedido cancelado
  REFUNDED   // Pedido estornado
}

// Papel do Usuário no sistema
enum Role {
  USER  // Cliente padrão
  ADMIN // Administrador da loja
}

// Tipo de Endereço (para Faturamento ou Envio)
enum AddressType {
  SHIPPING
  BILLING
}

// --- MODELOS PRINCIPAIS ---

// Modelo de Usuário (Cliente ou Admin)
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String // Senha deve ser sempre armazenada como hash (ex: bcrypt)
  firstName     String
  lastName      String
  phone         String?
  cpf           String?   @unique
  birthDate     DateTime?
  role          Role      @default(USER)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relações do Usuário
  addresses     Address[]
  orders        Order[]
  reviews       Review[]
  wishlistItems WishlistItem[]
  cart          Cart? // Um usuário tem um carrinho
}

// Endereços do Usuário (separado para múltiplos endereços)
model Address {
  id           String      @id @default(cuid())
  street       String
  city         String
  state        String
  postalCode   String
  country      String
  addressLine2 String? // Ex: Apartamento, Bloco
  type         AddressType @default(SHIPPING)

  // Relação com Usuário
  user   User   @relation(fields: [userId], references: [id])
  userId String

  // Relação com Pedidos (um endereço pode ser usado em muitos pedidos)
  shippingOrders Order[] @relation("ShippingAddress")
  billingOrders  Order[] @relation("BillingAddress")

  @@index([userId])
}

// Categorias de Produto (ex: "Feminino", "Masculino", "Camisetas")
model Category {
  id     String  @id @default(cuid())
  name   String
  slug   String  @unique // Para URLs amigáveis (ex: "camisetas-masculinas")

  // Relação de auto-referência para sub-categorias
  parentId String?
  parent   Category?  @relation("SubCategories", fields: [parentId], references: [id])
  children Category[] @relation("SubCategories")
  
  // Relação com Produtos
  products Product[]
}

// Marcas (ex: "Nike", "Adidas", "Allure")
model Brand {
  id      String    @id @default(cuid())
  name    String
  slug    String    @unique
  logoUrl String?
  
  // Relação com Produtos
  products Product[]
}

// --- MODELOS DE PRODUTO (A PARTE MAIS COMPLEXA) ---

// O Produto "Pai" (ex: "Camisa Social de Linho")
// Contém informações gerais, mas não o estoque.
model Product {
  id          String   @id @default(cuid())
  name        String
  description String
  slug        String   @unique
  basePrice   Decimal  @db.Decimal(10, 2) // O preço "a partir de"
  isPromotional Boolean @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relações com Categoria e Marca
  category   Category @relation(fields: [categoryId], references: [id])
  categoryId String
  brand      Brand?   @relation(fields: [brandId], references: [id])
  brandId    String?

  // Relações "Filhas"
  variants      ProductVariant[] // As variações (ex: Vermelha/M, Azul/G)
  images        ProductImage[]   // Imagens gerais do produto
  reviews       Review[]
  wishlistItems WishlistItem[]

  @@index([categoryId])
  @@index([brandId])
}

// Atributos definíveis (ex: "Cor", "Tamanho")
model Attribute {
  id    String @id @default(cuid())
  name  String @unique // "Cor"
  slug  String @unique // "cor"
  
  // Relação com seus valores
  values AttributeValue[]
}

// Valores dos Atributos (ex: "Vermelho", "M")
model AttributeValue {
  id    String @id @default(cuid())
  value String // "Vermelho", "M", "40"
  meta  String? // Pode ser usado para hex colors (ex: "#FF0000")

  // Relação com o Atributo "Pai"
  attribute   Attribute @relation(fields: [attributeId], references: [id])
  attributeId String

  // Relação com as Variantes
  variantAttributes ProductVariantAttributeValue[]

  @@index([attributeId])
}

// A Variante de Produto (O item vendável, ex: "Camisa Vermelha M")
// É AQUI que o estoque e o SKU são controlados.
model ProductVariant {
  id    String  @id @default(cuid())
  sku   String  @unique // Stock Keeping Unit (SKU)
  price Decimal @db.Decimal(10, 2) // Preço específico desta variante
  stock Int     @default(0) // Quantidade em estoque

  // Relação com o Produto "Pai"
  product   Product @relation(fields: [productId], references: [id])
  productId String

  // Relações "Filhas"
  images        ProductImage[] // Imagens específicas da variante (ex: fotos da cor vermelha)
  orderItems    OrderItem[]
  cartItems     CartItem[]
  
  // Relação com os Atributos (via tabela de junção)
  attributes ProductVariantAttributeValue[]

  @@index([productId])
}

// Tabela de Junção: ProductVariant <-> AttributeValue
// Permite que uma variante (Camisa Vermelha M) tenha múltiplos atributos (Cor=Vermelha, Tamanho=M)
model ProductVariantAttributeValue {
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id], onDelete: Cascade)
  productVariantId String
  attributeValue   AttributeValue @relation(fields: [attributeValueId], references: [id], onDelete: Cascade)
  attributeValueId String

  @@id([productVariantId, attributeValueId]) // Chave primária composta
  @@index([attributeValueId])
}

// Imagens do Produto (podem estar ligadas ao Produto ou à Variante)
model ProductImage {
  id     String  @id @default(cuid())
  url    String  // URL da imagem (CDN)
  altText String?
  priority Int   @default(0) // Para ordenar as imagens

  // Relação com Produto (para imagens gerais)
  product   Product @relation(fields: [productId], references: [id])
  productId String

  // Relação Opcional com Variante (para imagens de cor específica)
  productVariant   ProductVariant? @relation(fields: [productVariantId], references: [id])
  productVariantId String?

  @@index([productId])
  @@index([productVariantId])
}


// --- MODELOS DE CARRINHO E PEDIDOS ---

// Carrinho de Compras do Usuário
model Cart {
  id        String   @id @default(cuid())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relação 1-para-1 com Usuário
  user   User   @relation(fields: [userId], references: [id])
  userId String @unique

  // Relação com Itens
  items CartItem[]
}

// Item dentro do Carrinho
model CartItem {
  id       String @id @default(cuid())
  quantity Int    @default(1)

  // Relação com Carrinho
  cart   Cart   @relation(fields: [cartId], references: [id])
  cartId String

  // Relação com a Variante de Produto (NÃO com o produto pai)
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  productVariantId String

  @@unique([cartId, productVariantId]) // Não pode ter a mesma variante 2x no carrinho
  @@index([cartId])
  @@index([productVariantId])
}

// Pedido
model Order {
  id             String      @id @default(cuid())
  status         OrderStatus @default(PENDING)
  subTotal       Decimal     @db.Decimal(10, 2)
  shippingFee    Decimal     @db.Decimal(10, 2)
  discountAmount Decimal     @db.Decimal(10, 2) @default(0.00)
  totalPrice     Decimal     @db.Decimal(10, 2) // subTotal + shippingFee - discount
  trackingNumber String?
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  // Relação com Usuário
  user   User   @relation(fields: [userId], references: [id])
  userId String

  // Relações com Endereços
  shippingAddress   Address @relation("ShippingAddress", fields: [shippingAddressId], references: [id])
  shippingAddressId String
  billingAddress    Address @relation("BillingAddress", fields: [billingAddressId], references: [id])
  billingAddressId  String

  // Relação com Itens do Pedido
  items OrderItem[]

  @@index([userId])
}

// Item do Pedido
model OrderItem {
  id        String @id @default(cuid())
  quantity  Int
  priceAtPurchase Decimal @db.Decimal(10, 2) // Preço do item no momento da compra (importante!)

  // Relação com Pedido
  order   Order  @relation(fields: [orderId], references: [id])
  orderId String

  // Relação com a Variante de Produto
  productVariant   ProductVariant @relation(fields: [productVariantId], references: [id])
  productVariantId String

  @@index([orderId])
  @@index([productVariantId])
}


// --- MODELOS DE SUPORTE ---

// Avaliações de Produto (Review)
model Review {
  id      String @id @default(cuid())
  rating  Int // Ex: 1 a 5
  comment String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relação com Usuário e Produto
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@unique([userId, productId]) // Usuário só pode avaliar um produto uma vez
  @@index([productId])
  @@index([userId])
}

// Lista de Desejos (Wishlist)
model WishlistItem {
  id String @id @default(cuid())
  
  // Relação com Usuário e Produto
  user      User    @relation(fields: [userId], references: [id])
  userId    String
  product   Product @relation(fields: [productId], references: [id])
  productId String

  @@unique([userId, productId]) // Não pode ter o mesmo produto duas vezes na wishlist
  @@index([userId])
  @@index([productId])
}
